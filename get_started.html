<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>COFFI: Getting Started with COFFI</title><!--MAX_FRAME_SIZE PROJECT_NAME-->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('get_started.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Getting Started with COFFI</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#reader">COFF File Reader</a></li>
<li class="level1"><a href="#accessors">COFF Data Accessors</a></li>
<li class="level1"><a href="#coffdump">COFFDump Utility</a></li>
<li class="level1"><a href="#writer">COFF File Writer</a><ul><li class="level2"><a href="#writer_source">Writing the program</a></li>
<li class="level2"><a href="#writer_test">Testing the program</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>I</p>
<p>This guide assumes that you are a little bit familiar with the COFF binary file format. See <a class="el" href="extdoc.html">External documentation</a> for more details on the COFF binary file format.</p>
<h1><a class="anchor" id="reader"></a>
COFF File Reader</h1>
<p>The <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> library is just normal C++ header files. In order to use all its classes and types, simply include the main header file "coffi.hpp". All <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> library declarations reside in a namespace called "COFFI". This can be seen in the following example (the full source file is in <a class="el" href="examples.html#examples_tutorial">examples/tutorial/tutorial.cpp</a>):</p>
<ul>
<li>Include the <a class="el" href="coffi_8hpp.html" title="The COFFI library include file.">coffi.hpp</a> header file</li>
<li>The <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> namespace usage</li>
</ul>
<div class="fragment"><div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor">#include &lt;<a class="code" href="coffi_8hpp.html">coffi/coffi.hpp</a>&gt;</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span> </div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_c_o_f_f_i.html">COFFI</a>;</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span> </div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span>{</div>
<div class="ttc" id="acoffi_8hpp_html"><div class="ttname"><a href="coffi_8hpp.html">coffi.hpp</a></div><div class="ttdoc">The COFFI library include file.</div></div>
<div class="ttc" id="anamespace_c_o_f_f_i_html"><div class="ttname"><a href="namespace_c_o_f_f_i.html">COFFI</a></div><div class="ttdoc">COFFI library namespace.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00066">coffi.hpp:66</a></div></div>
</div><!-- fragment --><p>This section of the tutorial will explain how to work with the reader portion of the <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> library. The first step would be creating a coffi class instance. The coffi constructor has no parameters. The creation is normally followed by invoking the 'load' member method, passing it an COFF file name as a parameter:</p>
<ul>
<li>Create the <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> class instance</li>
<li>Initialize the instance by loading a COFF file. The function <a class="el" href="class_c_o_f_f_i_1_1coffi.html#a0803929aba84c459035a72939a3c8265">load()</a> returns <code>true</code> if the COFF file was found and processed successfully. It returns <code>false</code> otherwise</li>
</ul>
<div class="fragment"><div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>    <span class="comment">// Create an coffi reader</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span>    <a class="code hl_class" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> reader;</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> </div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>    <span class="comment">// Load COFF data</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>    <span class="keywordflow">if</span> (!reader.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a0803929aba84c459035a72939a3c8265">load</a>(argv[1])) {</div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>        std::cout &lt;&lt; <span class="stringliteral">&quot;Can&#39;t find or process COFF file &quot;</span> &lt;&lt; argv[1] &lt;&lt; std::endl;</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>        <span class="keywordflow">return</span> 2;</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>    }</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html">COFFI::coffi</a></div><div class="ttdoc">The COFFI library's main class.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00070">coffi.hpp:73</a></div></div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_a0803929aba84c459035a72939a3c8265"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#a0803929aba84c459035a72939a3c8265">COFFI::coffi::load</a></div><div class="ttdeci">bool load(const std::string &amp;file_name)</div><div class="ttdoc">Initializes the coffi object by loading data from COFF binary file.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00097">coffi.hpp:97</a></div></div>
</div><!-- fragment --><p>All the COFF file header properties such as the architecture are accessible now. To get the architecture of the file use:</p>
<ul>
<li>The member function <a class="el" href="class_c_o_f_f_i_1_1coffi.html#a80222b60c645977bf51659414273af5e">get_architecture()</a> returns the COFF architecture. Possible return values are listed in <a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89">coffi_architecture_t.</a></li>
<li>The member function <a class="el" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header()</a> returns the COFF file optional header. The member function <a class="el" href="class_c_o_f_f_i_1_1optional__header.html">get_magic()</a> returns the <a class="el" href="struct_c_o_f_f_i_1_1coff__optional__header__pe.html#a8c61e64b8675498cee79c59d3f8131e2">magic</a> field of the optional header.</li>
</ul>
<div class="fragment"><div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>    <span class="comment">// Print COFF file properties</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;COFF file architecture: &quot;</span>;</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span>    <span class="keywordflow">switch</span> (reader.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a80222b60c645977bf51659414273af5e">get_architecture</a>()) {</div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>    <span class="keywordflow">case</span> COFFI_ARCHITECTURE_PE:</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>        <span class="keywordflow">if</span> (reader.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()) {</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>            <span class="keywordflow">if</span> (reader.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()-&gt;get_magic() ==</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>                <a class="code hl_define" href="coffi__types_8hpp.html#a48630e2e9e77ac712328e14fa242bae6">OH_MAGIC_PE32PLUS</a>) {</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>                std::cout &lt;&lt; <span class="stringliteral">&quot;Portable Executable PE32+&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>            }</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>            <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>                std::cout &lt;&lt; <span class="stringliteral">&quot;Portable Executable PE32&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>            }</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>        }</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>            std::cout &lt;&lt; <span class="stringliteral">&quot;Portable Executable&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>        }</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>    <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba">COFFI_ARCHITECTURE_CEVA</a>:</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>        std::cout &lt;&lt; <span class="stringliteral">&quot;CEVA&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>    <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da">COFFI_ARCHITECTURE_TI</a>:</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>        std::cout &lt;&lt; <span class="stringliteral">&quot;Texas Instruments&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>    }</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_a80222b60c645977bf51659414273af5e"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#a80222b60c645977bf51659414273af5e">COFFI::coffi::get_architecture</a></div><div class="ttdeci">coffi_architecture_t get_architecture() const</div><div class="ttdoc">Returns the coffi object architecture.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00572">coffi.hpp:572</a></div></div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_aa3719ba4b4fd9207840bf16a23c02439"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">COFFI::coffi::get_optional_header</a></div><div class="ttdeci">optional_header * get_optional_header()</div><div class="ttdoc">Returns the optional COFF header.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00448">coffi.hpp:448</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_a48630e2e9e77ac712328e14fa242bae6"><div class="ttname"><a href="coffi__types_8hpp.html#a48630e2e9e77ac712328e14fa242bae6">OH_MAGIC_PE32PLUS</a></div><div class="ttdeci">#define OH_MAGIC_PE32PLUS</div><div class="ttdoc">PE32+ format.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00092">coffi_types.hpp:92</a></div></div>
<div class="ttc" id="anamespace_c_o_f_f_i_html_a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba"><div class="ttname"><a href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba">COFFI::COFFI_ARCHITECTURE_CEVA</a></div><div class="ttdeci">@ COFFI_ARCHITECTURE_CEVA</div><div class="ttdoc">CEVA Inc.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00646">coffi_types.hpp:646</a></div></div>
<div class="ttc" id="anamespace_c_o_f_f_i_html_a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da"><div class="ttname"><a href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da">COFFI::COFFI_ARCHITECTURE_TI</a></div><div class="ttdeci">@ COFFI_ARCHITECTURE_TI</div><div class="ttdoc">Texas Instruments.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00644">coffi_types.hpp:644</a></div></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The COFF types, flags and constants are defined in the <a class="el" href="coffi__types_8hpp.html" title="COFFI library basic structures and types.">coffi_types.hpp</a> header file. This file is included automatically into the project. For example: <a class="el" href="coffi__types_8hpp.html#a0796488aadc9efd23d922e3f298b9d71" title="PE32 format.">OH_MAGIC_PE32</a>, <a class="el" href="coffi__types_8hpp.html#a48630e2e9e77ac712328e14fa242bae6" title="PE32+ format.">OH_MAGIC_PE32PLUS</a> constants define values for PE32/PE32+ formats.</dd></dl>
<p>COFF binary files might consist of (some items are optional):</p>
<ul>
<li>File headers</li>
<li>Data directories (for the for PE architecture only), including:<ul>
<li>Import/export information</li>
<li>Resource information,</li>
<li>Etc.</li>
</ul>
</li>
<li>Sections, including:<ul>
<li>A header</li>
<li>Some raw data</li>
<li>Relocations entries</li>
<li>Line number entries</li>
</ul>
</li>
<li>A symbol table</li>
<li>A strings table</li>
</ul>
<p>Each section has its own responsibility: some contains executable code, others program's data, and so on. See COFF binary format documentation for your specific architecture for purpose and content description of sections and segments. The following code demonstrates how to find out the amount of sections the COFF file contains. The code also presents how to access particular section properties like names and sizes:</p>
<ul>
<li>The <a class="el" href="class_c_o_f_f_i_1_1coffi.html#a7ed35182300cc55f556034a2eb4b9a46">get_sections()</a> member of <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a>'s <code>reader</code> object allows to retrieve the number of sections inside a given COFF file. It could also be used to get access to individual sections by using the subscript operator[], which returns a pointer to the corresponding section's interface.</li>
<li>Use the C++ range-based <code>for</code> loop to loop through the sections given by <a class="el" href="class_c_o_f_f_i_1_1coffi.html#a7ed35182300cc55f556034a2eb4b9a46">get_sections()</a>. Sections can also be addressed with the subscript operator[], by its <a class="el" href="class_c_o_f_f_i_1_1sections.html#a61b36fcfa6f671fc462752ee8d6f28b2">number</a> or <a class="el" href="class_c_o_f_f_i_1_1sections.html#a8ac76277498a295cab0ad2c457ed11d3">symbolic name</a>.</li>
<li>get_index(), get_name() and get_data_size() are member functions of the <a class="el" href="class_c_o_f_f_i_1_1section.html">section</a> class.</li>
</ul>
<div class="fragment"><div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>    <span class="comment">// Print the COFF file sections info</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>    <span class="keyword">auto</span> sec_num = reader.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a7ed35182300cc55f556034a2eb4b9a46">get_sections</a>().size();</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of sections: &quot;</span> &lt;&lt; sec_num &lt;&lt; std::endl;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> sec : reader.get_sections()) {</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>        std::cout &lt;&lt; <span class="stringliteral">&quot;  [&quot;</span> &lt;&lt; sec-&gt;get_index() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; sec-&gt;get_name()</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>                  &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; sec-&gt;get_data_size() &lt;&lt; std::endl;</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>    }</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_a7ed35182300cc55f556034a2eb4b9a46"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#a7ed35182300cc55f556034a2eb4b9a46">COFFI::coffi::get_sections</a></div><div class="ttdeci">sections &amp; get_sections()</div><div class="ttdoc">Returns a list of the COFF sections.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00475">coffi.hpp:475</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="accessors"></a>
COFF Data Accessors</h1>
<p>To simplify creation and interpretation of specific COFF elements, the <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> library provides accessor classes.</p>
<p>Currently, the following classes are available:</p>
<table class="doxtable">
<tr>
<th>COFF item accessed </th><th>Class </th><th>Basic structure <br  />
(maps directly to the the file) </th><th>Applicable for <br  />
architecture </th></tr>
<tr>
<td>MS-DOS header </td><td><a class="el" href="class_c_o_f_f_i_1_1dos__header.html">dos_header</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1msdos__header.html">msdos_header</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
<tr>
<td rowspan="2">COFF file header </td><td><a class="el" href="class_c_o_f_f_i_1_1coff__header__impl.html">coff_header_impl</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1coff__file__header.html">coff_file_header</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a>, <a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba">CEVA</a> </td></tr>
<tr>
<td><a class="el" href="class_c_o_f_f_i_1_1coff__header__impl__ti.html">coff_header_impl_ti</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1coff__file__header__ti.html">coff_file_header_ti</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da">TI</a> </td></tr>
<tr>
<td rowspan="3">COFF optional file header </td><td><a class="el" href="class_c_o_f_f_i_1_1optional__header__impl__pe.html">optional_header_impl_pe</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1coff__optional__header__pe.html">coff_optional_header_pe</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a>, <a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba">CEVA</a> </td></tr>
<tr>
<td><a class="el" href="class_c_o_f_f_i_1_1optional__header__impl__pe__plus.html">optional_header_impl_pe_plus</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1coff__optional__header__pe__plus.html">coff_optional_header_pe_plus</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
<tr>
<td><a class="el" href="class_c_o_f_f_i_1_1optional__header__impl__ti.html">optional_header_impl_ti</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1common__optional__header__ti.html">common_optional_header_ti</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da">TI</a> </td></tr>
<tr>
<td rowspan="2">Windows NT file header </td><td><a class="el" href="class_c_o_f_f_i_1_1win__header__impl.html">win_header_impl&lt;win_header_pe&gt;</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1win__header__pe.html">win_header_pe</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
<tr>
<td><a class="el" href="class_c_o_f_f_i_1_1win__header__impl.html">win_header_impl&lt;win_header_pe_plus&gt;</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1win__header__pe__plus.html">win_header_pe_plus</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
<tr>
<td rowspan="2">Section header </td><td><a class="el" href="class_c_o_f_f_i_1_1section__impl.html">section_impl</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1section__header.html">section_header</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a>, <a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba">CEVA</a> </td></tr>
<tr>
<td><a class="el" href="class_c_o_f_f_i_1_1section__impl__ti.html">section_impl_ti</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1section__header__ti.html">section_header_ti</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da">TI</a> </td></tr>
<tr>
<td>Data directory </td><td><a class="el" href="class_c_o_f_f_i_1_1directory.html">directory</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
<tr>
<td rowspan="3">Relocation entry </td><td rowspan="3"><a class="el" href="class_c_o_f_f_i_1_1relocation.html">relocation</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1rel__entry.html">rel_entry</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
<tr>
<td><a class="el" href="struct_c_o_f_f_i_1_1rel__entry__ceva.html">rel_entry_ceva</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a7dba18e670d50d4f5a4fa119770bb9ba">CEVA</a> </td></tr>
<tr>
<td><a class="el" href="struct_c_o_f_f_i_1_1rel__entry__ti.html">rel_entry_ti</a> </td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a886949389fcba9f143c73d3be6d419da">TI</a> </td></tr>
<tr>
<td rowspan="2">Symbol </td><td rowspan="2"><a class="el" href="class_c_o_f_f_i_1_1symbol.html">symbol</a> </td><td><a class="el" href="struct_c_o_f_f_i_1_1symbol__record.html">symbol_record</a> <br  />
See also:<ul>
<li><a class="el" href="struct_c_o_f_f_i_1_1auxiliary__symbol__record.html">auxiliary_symbol_record</a>  </li>
</ul>
</td><td>All </td></tr>
<tr>
<td><ul>
<li><a class="el" href="struct_c_o_f_f_i_1_1auxiliary__symbol__record__1.html">auxiliary_symbol_record_1</a></li>
<li><a class="el" href="struct_c_o_f_f_i_1_1auxiliary__symbol__record__2.html">auxiliary_symbol_record_2</a></li>
<li><a class="el" href="struct_c_o_f_f_i_1_1auxiliary__symbol__record__3.html">auxiliary_symbol_record_3</a></li>
<li><a class="el" href="struct_c_o_f_f_i_1_1auxiliary__symbol__record__4.html">auxiliary_symbol_record_4</a></li>
<li><a class="el" href="struct_c_o_f_f_i_1_1auxiliary__symbol__record__5.html">auxiliary_symbol_record_5</a>  </li>
</ul>
</td><td><a class="el" href="namespace_c_o_f_f_i.html#a8b42b49bb8d2c0fa2fd33b2efd240c89a244d6357008ca811cdba08f4c47b353e">PE</a> </td></tr>
</table>
<p>See also the <a class="el" href="coffi__utils_8hpp.html#group_access">macros for accessing the COFF structures fields</a>.</p>
<h1><a class="anchor" id="coffdump"></a>
COFFDump Utility</h1>
<p>The source code for the COFFDump Utility can be found in the <code>examples</code> directory. An example of output is presented <a class="el" href="get_started.html#hello_dump">below</a>.</p>
<h1><a class="anchor" id="writer"></a>
COFF File Writer</h1>
<h2><a class="anchor" id="writer_source"></a>
Writing the program</h2>
<p>In this section we will create a simple COFF executable file that prints out the classical "Hello, World!" message.</p>
<p>The executable will be created and run on a Windows platform. It is supposed to run well on both 32 and 64-bit Windows platforms. The full source file is in <a class="el" href="examples.html#examples_writer">examples/writer/writer.cpp</a>.</p>
<p>The file will be created <b>without</b> invoking the compiler or assembler tools in the usual way (i.e. translating high level source code that makes use of the standard library functions).</p>
<p>Instead, using the <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> writer, all the necessary sections and data of the file will be created and filled explicitly, each, with its appropriate data. The physical file would then be created by the <a class="el" href="namespace_c_o_f_f_i.html" title="COFFI library namespace.">COFFI</a> library.</p>
<p>Before starting, implementations details of <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> that users should be aware of are:</p>
<ul>
<li>The <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> class, while constructing, creates the string table section automatically.</li>
<li>The <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> class computes and updates the offsets, sizes, etc., either while constructing, or when saving the file. The <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> class tries to keep the various sections and other elements in the same order as given by the user.</li>
</ul>
<p>Our usage of the library API will consist of several steps:</p>
<ul>
<li>Creating an empty coffi object</li>
<li>Setting-up COFF file properties</li>
<li>Creating code section and data content for it</li>
<li>Creating data section and its content</li>
<li>Addition of both sections to corresponding COFF file segments</li>
<li>Setting-up the program's entry point</li>
<li>Dumping the coffi object to an executable COFF file</li>
</ul>
<p>Initialize an empty <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> object. This should be done as the first step when creating a new <a class="el" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> object, because the other API is relying on parameter provided (COFF file architecture).</p>
<div class="fragment"><div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="preprocessor">#include &lt;<a class="code" href="coffi_8hpp.html">coffi/coffi.hpp</a>&gt;</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span> </div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_c_o_f_f_i.html">COFFI</a>;</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> </div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="comment">// clang-format off</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span> </div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="keywordtype">void</span> write_the_file( <span class="keyword">const</span> std::string &amp;filename )</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>{</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>    <a class="code hl_class" href="class_c_o_f_f_i_1_1coffi.html">coffi</a> writer;</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>    </div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>    <span class="comment">// You can&#39;t proceed without this function call!</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#acf0be4cf0f0ebabc02db2045149f59b6">create</a>(COFFI_ARCHITECTURE_PE);</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_acf0be4cf0f0ebabc02db2045149f59b6"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#acf0be4cf0f0ebabc02db2045149f59b6">COFFI::coffi::create</a></div><div class="ttdeci">void create(coffi_architecture_t architecture)</div><div class="ttdoc">Cleans and/or initializes the coffi object.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00353">coffi.hpp:353</a></div></div>
</div><!-- fragment --><p>Initialize an optional header.</p>
<div class="fragment"><div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>    <span class="comment">// Create the optional header (required for images *.exe, *.dll)</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aeae1c4afb2ec0bf95dc1502e4d70f7c0">create_optional_header</a>();</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_aeae1c4afb2ec0bf95dc1502e4d70f7c0"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#aeae1c4afb2ec0bf95dc1502e4d70f7c0">COFFI::coffi::create_optional_header</a></div><div class="ttdeci">void create_optional_header(uint16_t magic=OH_MAGIC_PE32)</div><div class="ttdoc">Initializes an optional header for the coffi object.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00389">coffi.hpp:389</a></div></div>
</div><!-- fragment --><p>Create a new section, set section's attributes. Section type, flags and alignment have a big significance and controls how this section is treated by a linker or OS loader. This code section contains the code that:</p>
<ul>
<li>Sets the <code>MessageBoxA</code> parameters</li>
<li>Calls <code>MessageBoxA</code></li>
<li>Sets the <code>ExitProcess</code> parameter</li>
<li>Calls <code>ExitProcess</code></li>
</ul>
<p>The <code>ExitProcess</code> and <code>MessageBoxA</code> functions are imported from the Windows DLL at adresses <code>0x40304C</code> and <code>0x403054</code>, see IAT (import address table) below.</p>
<div class="fragment"><div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    <span class="comment">// Create code section</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    <a class="code hl_class" href="class_c_o_f_f_i_1_1section.html">section</a>* text_sec = writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a0d054679888f10b60f6919b14784302b">add_section</a>( <span class="stringliteral">&quot;.text&quot;</span> );</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    <span class="keywordtype">char</span> text[] = {</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>        <span class="stringliteral">&#39;\x6A&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,                                 <span class="comment">// push 0</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>        <span class="stringliteral">&#39;\x68&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="stringliteral">&#39;\x20&#39;</span>, <span class="stringliteral">&#39;\x40&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,         <span class="comment">// push offset 0x00402000 (string in the .rdata section)</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>        <span class="stringliteral">&#39;\x68&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="stringliteral">&#39;\x20&#39;</span>, <span class="stringliteral">&#39;\x40&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,         <span class="comment">// push offset 0x00402000 (string in the .rdata section)</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>        <span class="stringliteral">&#39;\x6A&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,                                 <span class="comment">// push 0</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>        <span class="stringliteral">&#39;\xE8&#39;</span>, <span class="stringliteral">&#39;\x0E&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,         <span class="comment">// call 0x401021</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>        <span class="stringliteral">&#39;\x6A&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,                                 <span class="comment">// push 0</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>        <span class="stringliteral">&#39;\xE8&#39;</span>, <span class="stringliteral">&#39;\x01&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>,         <span class="comment">// call 0x40101b</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>        <span class="stringliteral">&#39;\xF4&#39;</span>,                                         <span class="comment">// hlt</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>        <span class="stringliteral">&#39;\xFF&#39;</span>, <span class="stringliteral">&#39;\x25&#39;</span>, <span class="stringliteral">&#39;\x4C&#39;</span>, <span class="stringliteral">&#39;\x30&#39;</span>, <span class="stringliteral">&#39;\x40&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>, <span class="comment">// 0x40101b: jmp *0x40304C (ExitProcess)</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>        <span class="stringliteral">&#39;\xFF&#39;</span>, <span class="stringliteral">&#39;\x25&#39;</span>, <span class="stringliteral">&#39;\x54&#39;</span>, <span class="stringliteral">&#39;\x30&#39;</span>, <span class="stringliteral">&#39;\x40&#39;</span>, <span class="stringliteral">&#39;\x00&#39;</span>  <span class="comment">// 0x401021: jmp *0x403054 (MessageBoxA)</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    };</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>    text_sec-&gt;set_data( text, <span class="keyword">sizeof</span>( text ) );</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>    text_sec-&gt;set_virtual_address(0x1000);</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>    text_sec-&gt;set_virtual_size(<span class="keyword">sizeof</span>(text));</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>    text_sec-&gt;set_flags(<a class="code hl_define" href="coffi__types_8hpp.html#a73f2d31800976c048f4b84c904936174">IMAGE_SCN_MEM_EXECUTE</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a> | <a class="code hl_define" href="coffi__types_8hpp.html#a705da0cf40a97198bcf9e2e2dcaa586b">IMAGE_SCN_CNT_CODE</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aa5f6f34a3f4da16a78e6dd69ef7cf027">IMAGE_SCN_ALIGN_4BYTES</a>);</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_a0d054679888f10b60f6919b14784302b"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#a0d054679888f10b60f6919b14784302b">COFFI::coffi::add_section</a></div><div class="ttdeci">section * add_section(const std::string &amp;name)</div><div class="ttdoc">Add a COFF section.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00488">coffi.hpp:488</a></div></div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1section_html"><div class="ttname"><a href="class_c_o_f_f_i_1_1section.html">COFFI::section</a></div><div class="ttdoc">Interface class for accessing a COFF section, for all the COFF architectures.</div><div class="ttdef"><b>Definition</b> <a href="coffi__section_8hpp_source.html#l00051">coffi_section.hpp:52</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_a705da0cf40a97198bcf9e2e2dcaa586b"><div class="ttname"><a href="coffi__types_8hpp.html#a705da0cf40a97198bcf9e2e2dcaa586b">IMAGE_SCN_CNT_CODE</a></div><div class="ttdeci">#define IMAGE_SCN_CNT_CODE</div><div class="ttdoc">The section contains executable code.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00147">coffi_types.hpp:147</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_a73f2d31800976c048f4b84c904936174"><div class="ttname"><a href="coffi__types_8hpp.html#a73f2d31800976c048f4b84c904936174">IMAGE_SCN_MEM_EXECUTE</a></div><div class="ttdeci">#define IMAGE_SCN_MEM_EXECUTE</div><div class="ttdoc">The section can be executed as code.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00178">coffi_types.hpp:178</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_aa5f6f34a3f4da16a78e6dd69ef7cf027"><div class="ttname"><a href="coffi__types_8hpp.html#aa5f6f34a3f4da16a78e6dd69ef7cf027">IMAGE_SCN_ALIGN_4BYTES</a></div><div class="ttdeci">#define IMAGE_SCN_ALIGN_4BYTES</div><div class="ttdoc">Align data on a 4 - byte boundary.Valid only for object files.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00161">coffi_types.hpp:161</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_aaa56eb4ef08717bfb86ae415d1a5d5be"><div class="ttname"><a href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a></div><div class="ttdeci">#define IMAGE_SCN_MEM_READ</div><div class="ttdoc">The section can be read.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00179">coffi_types.hpp:179</a></div></div>
</div><!-- fragment --><p>Add a data section, storing the overwhelmingly impressive message.</p>
<div class="fragment"><div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>    <span class="comment">// Create a .rdata section, with the string</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    <a class="code hl_class" href="class_c_o_f_f_i_1_1section.html">section</a>* rdata_sec = writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a0d054679888f10b60f6919b14784302b">add_section</a>( <span class="stringliteral">&quot;.rdata&quot;</span> );</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>    <span class="keywordtype">char</span> rdata[] = <span class="stringliteral">&quot;Hello World!\0&quot;</span>;</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>    rdata_sec-&gt;set_data( rdata, <span class="keyword">sizeof</span>( rdata ) );</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>    rdata_sec-&gt;set_virtual_address(0x2000);</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>    rdata_sec-&gt;set_virtual_size(<span class="keyword">sizeof</span>(rdata));</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>    rdata_sec-&gt;set_flags(<a class="code hl_define" href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a> | <a class="code hl_define" href="coffi__types_8hpp.html#a459812511eb7707011354e4a76ed71f6">IMAGE_SCN_CNT_INITIALIZED_DATA</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aa5f6f34a3f4da16a78e6dd69ef7cf027">IMAGE_SCN_ALIGN_4BYTES</a>);</div>
<div class="ttc" id="acoffi__types_8hpp_html_a459812511eb7707011354e4a76ed71f6"><div class="ttname"><a href="coffi__types_8hpp.html#a459812511eb7707011354e4a76ed71f6">IMAGE_SCN_CNT_INITIALIZED_DATA</a></div><div class="ttdeci">#define IMAGE_SCN_CNT_INITIALIZED_DATA</div><div class="ttdoc">The section contains initialized data.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00148">coffi_types.hpp:148</a></div></div>
</div><!-- fragment --><p>Add a data section, used by Windows for importing DLL (run-time link). Refer to the Windows documentation for more details. The code below imports <code>ExitProcess</code> and <code>MessageBoxA</code> from <code>KERNEL32.dll</code> and <code>USER32.dll</code> respectively.</p>
<div class="fragment"><div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>    <span class="comment">// Create a .idata section</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>    <a class="code hl_class" href="class_c_o_f_f_i_1_1section.html">section</a>* idata_sec = writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a0d054679888f10b60f6919b14784302b">add_section</a>( <span class="stringliteral">&quot;.idata&quot;</span> );</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>    uint8_t idata[] = {</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>        <span class="comment">// RVA = 0x3000</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span> </div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>        <span class="comment">// Import table (array of IMAGE_IMPORT_DESCRIPTOR structures)</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>        0x3C, 0x30, 0x00, 0x00,     <span class="comment">// OriginalFirstThunk: offset of the import lookup table</span></div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// TimeDateStamp</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// ForwarderChain</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>        0x5C, 0x30, 0x00, 0x00,     <span class="comment">// Name: Offset of &quot;KERNEL32.dll&quot;</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>        0x4C, 0x30, 0x00, 0x00,     <span class="comment">// FirstThunk: offset of import address table</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span> </div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>        <span class="comment">// Import table (array of IMAGE_IMPORT_DESCRIPTOR structures)</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>        0x44, 0x30, 0x00, 0x00,     <span class="comment">// OriginalFirstThunk: offset of the import lookup table</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// TimeDateStamp</span></div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// ForwarderChain</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>        0x6C, 0x30, 0x00, 0x00,     <span class="comment">// Name: Offset of &quot;USER32.dll&quot;</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>        0x54, 0x30, 0x00, 0x00,     <span class="comment">// FirstThunk: offset of import address table</span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span> </div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>        <span class="comment">// Empty IMAGE_IMPORT_DESCRIPTOR structure (signaling the end of the IMAGE_IMPORT_DESCRIPTOR array)</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// OriginalFirstThunk</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// TimeDateStamp</span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// ForwarderChain</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// Name</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">// FirstThunk</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>        <span class="comment">// Import lookup table (array of IMAGE_THUNK_DATA structures)</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>        <span class="comment">// RVA = 0x303C</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>        0x7C, 0x30, 0x00, 0x00,     <span class="comment">// Import function by name</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">//</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>        <span class="comment">// RVA = 0x3044</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>        0x8C, 0x30, 0x00, 0x00,     <span class="comment">// Import function by name</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">//</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span> </div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>        <span class="comment">// Import address table (array of IMAGE_THUNK_DATA structures)</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>        <span class="comment">// RVA = 0x304C</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>        0x7C, 0x30, 0x00, 0x00,     <span class="comment">// Import function by name</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">//</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>        <span class="comment">// RVA = 0x3054</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>        0x8C, 0x30, 0x00, 0x00,     <span class="comment">// Import function by name</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>        0x00, 0x00, 0x00, 0x00,     <span class="comment">//</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span> </div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>        <span class="comment">// Names</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>        <span class="comment">// RVA = 0x305C</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>        <span class="charliteral">&#39;K&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;N&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;L&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, 0, 0, 0, 0,</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>        <span class="comment">// RVA = 0x306C</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>        <span class="charliteral">&#39;U&#39;</span>, <span class="charliteral">&#39;S&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;l&#39;</span>,  0,   0,  0, 0, 0, 0,</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span> </div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>        <span class="comment">// Hint/Name Table</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>        <span class="comment">// RVA = 0x307C</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>        0x5E, 0x01, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;x&#39;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;o&#39;</span>, <span class="charliteral">&#39;c&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, 0, 0, 0,</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>        <span class="comment">// RVA = 0x308C</span></div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>        0x7F, 0x02, <span class="charliteral">&#39;M&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;o&#39;</span>, <span class="charliteral">&#39;x&#39;</span>, <span class="charliteral">&#39;A&#39;</span>, 0, 0, 0,</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>    };</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span> </div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    idata_sec-&gt;set_data( (<span class="keywordtype">char</span>*)idata, <span class="keyword">sizeof</span>( idata ) );</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>    idata_sec-&gt;set_virtual_address(0x3000);</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>    idata_sec-&gt;set_virtual_size(<span class="keyword">sizeof</span>(idata));</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>    idata_sec-&gt;set_flags(<a class="code hl_define" href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a> | <a class="code hl_define" href="coffi__types_8hpp.html#a459812511eb7707011354e4a76ed71f6">IMAGE_SCN_CNT_INITIALIZED_DATA</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aa5f6f34a3f4da16a78e6dd69ef7cf027">IMAGE_SCN_ALIGN_4BYTES</a>);</div>
</div><!-- fragment --><p>Add a relocation section, used by Windows for loading the file. The relocation entries identify the places in the code section where there are addresses to be relocated.</p>
<div class="fragment"><div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>    <span class="comment">// Create a .reloc section</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>    <a class="code hl_class" href="class_c_o_f_f_i_1_1section.html">section</a>* reloc_sec = writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a0d054679888f10b60f6919b14784302b">add_section</a>( <span class="stringliteral">&quot;.reloc&quot;</span> );</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>    uint16_t reloc[] = {</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>        0x1000, 0x0000, <span class="comment">// RVA of relocation block</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>        0x0010, 0x0000, <span class="comment">// Size of the relocation block</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>        0x3003, <span class="comment">// Relocation HIGHLOW at address 0x1003</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>        0x3008, <span class="comment">// Relocation HIGHLOW at address 0x1008</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>        0x301D, <span class="comment">// Relocation HIGHLOW at address 0x101D</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>        0x3023, <span class="comment">// Relocation HIGHLOW at address 0x1023</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    };</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>    reloc_sec-&gt;set_data( (<span class="keywordtype">char</span>*)reloc, <span class="keyword">sizeof</span>( reloc ) );</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>    reloc_sec-&gt;set_virtual_address(0x4000);</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>    reloc_sec-&gt;set_virtual_size(<span class="keyword">sizeof</span>(reloc));</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    reloc_sec-&gt;set_flags(<a class="code hl_define" href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aaa56eb4ef08717bfb86ae415d1a5d5be">IMAGE_SCN_MEM_READ</a> | <a class="code hl_define" href="coffi__types_8hpp.html#a459812511eb7707011354e4a76ed71f6">IMAGE_SCN_CNT_INITIALIZED_DATA</a> | <a class="code hl_define" href="coffi__types_8hpp.html#aa5f6f34a3f4da16a78e6dd69ef7cf027">IMAGE_SCN_ALIGN_4BYTES</a>);</div>
</div><!-- fragment --><p>Update the file headers</p>
<div class="fragment"><div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>    <span class="comment">// Set headers properties</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aec5fa3f9fa0bb797f989e4ac51cbea4e">get_header</a>()-&gt;set_flags(<a class="code hl_define" href="coffi__types_8hpp.html#a121e58695f306ceb8dbdd467303f4c0f">IMAGE_FILE_EXECUTABLE_IMAGE</a> | <a class="code hl_define" href="coffi__types_8hpp.html#ad5dd50d82c0f16eea0ee5c5dcd2c9f1c">IMAGE_FILE_32BIT_MACHINE</a>);</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()-&gt;set_code_size(0x200);</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()-&gt;set_initialized_data_size(0x400);</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()-&gt;set_entry_point_address(0x00001000);</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()-&gt;set_code_base(0x00001000);</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa3719ba4b4fd9207840bf16a23c02439">get_optional_header</a>()-&gt;set_data_base(0x00002000);</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_image_base(0x00400000);</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_section_alignment(0x1000);</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_major_os_version(4);</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_major_image_version(1);</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_major_subsystem_version(4);</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_image_size(0x5000);</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_headers_size(0x200);</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_subsystem(3); <span class="comment">// Windows CUI</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_stack_reserve_size(0x00100000);</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_stack_commit_size(0x1000);</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_heap_reserve_size(0x100000);</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">get_win_header</a>()-&gt;set_heap_commit_size(0x1000);</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_aa0e679e6e3669d63ebc181355daef5e7"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#aa0e679e6e3669d63ebc181355daef5e7">COFFI::coffi::get_win_header</a></div><div class="ttdeci">win_header * get_win_header()</div><div class="ttdoc">Returns the Windows NT header.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00463">coffi.hpp:463</a></div></div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_aec5fa3f9fa0bb797f989e4ac51cbea4e"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#aec5fa3f9fa0bb797f989e4ac51cbea4e">COFFI::coffi::get_header</a></div><div class="ttdeci">coff_header * get_header()</div><div class="ttdoc">Returns the COFF header.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00436">coffi.hpp:436</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_a121e58695f306ceb8dbdd467303f4c0f"><div class="ttname"><a href="coffi__types_8hpp.html#a121e58695f306ceb8dbdd467303f4c0f">IMAGE_FILE_EXECUTABLE_IMAGE</a></div><div class="ttdeci">#define IMAGE_FILE_EXECUTABLE_IMAGE</div><div class="ttdoc">Image only. Indicates that the image file is valid and can be run. If this flag is not set,...</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00100">coffi_types.hpp:100</a></div></div>
<div class="ttc" id="acoffi__types_8hpp_html_ad5dd50d82c0f16eea0ee5c5dcd2c9f1c"><div class="ttname"><a href="coffi__types_8hpp.html#ad5dd50d82c0f16eea0ee5c5dcd2c9f1c">IMAGE_FILE_32BIT_MACHINE</a></div><div class="ttdeci">#define IMAGE_FILE_32BIT_MACHINE</div><div class="ttdoc">Machine based on 32-bit-word architecture.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00107">coffi_types.hpp:107</a></div></div>
</div><!-- fragment --><p>Update the data directories, especially those pointing to the DLL import information and relocation information.</p>
<div class="fragment"><div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>    <span class="comment">// Add directories (required for images *.exe, *.dll)</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Export Directory [.edata (or where ever we found it)]</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{idata_sec-&gt;get_virtual_address(), idata_sec-&gt;get_virtual_size()}); <span class="comment">// Import Directory [parts of .idata]</span></div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Resource Directory [.rsrc]</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Exception Directory [.pdata]</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Security Directory</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{reloc_sec-&gt;get_virtual_address(), reloc_sec-&gt;get_virtual_size()}); <span class="comment">// Base Relocation Directory [.reloc]</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Debug Directory</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Description Directory</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Special Directory</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Thread Storage Directory [.tls]</span></div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Load Configuration Directory</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Bound Import Directory</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0x304C, 0x10}); <span class="comment">// Import Address Table Directory</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Delay Import Directory</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// CLR Runtime Header</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">add_directory</a>(<a class="code hl_struct" href="struct_c_o_f_f_i_1_1image__data__directory.html">image_data_directory</a>{0, 0}); <span class="comment">// Reserved</span></div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_a66c39fa1cfecf2b9b2ce7873b32ab5d0"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#a66c39fa1cfecf2b9b2ce7873b32ab5d0">COFFI::coffi::add_directory</a></div><div class="ttdeci">directory * add_directory(const image_data_directory &amp;rva_and_size)</div><div class="ttdoc">Add a PE data directory.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00525">coffi.hpp:525</a></div></div>
<div class="ttc" id="astruct_c_o_f_f_i_1_1image__data__directory_html"><div class="ttname"><a href="struct_c_o_f_f_i_1_1image__data__directory.html">COFFI::image_data_directory</a></div><div class="ttdoc">PE data directory.</div><div class="ttdef"><b>Definition</b> <a href="coffi__types_8hpp_source.html#l00928">coffi_types.hpp:929</a></div></div>
</div><!-- fragment --><p>Save the COFF binary file on disk:</p>
<div class="fragment"><div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>    <span class="comment">// Recompute all the offsets in the file</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#aeb57d11704c0ddd3ff515aa5b8c8c5a4">layout</a>();</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span> </div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>    <span class="comment">// Create the PE file</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>    writer.<a class="code hl_function" href="class_c_o_f_f_i_1_1coffi.html#a66e384c8159eb8c27280d0ebfa1eb6ca">save</a>( filename );</div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_a66e384c8159eb8c27280d0ebfa1eb6ca"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#a66e384c8159eb8c27280d0ebfa1eb6ca">COFFI::coffi::save</a></div><div class="ttdeci">bool save(const std::string &amp;file_name)</div><div class="ttdoc">Creates a file in COFF binary format.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00310">coffi.hpp:310</a></div></div>
<div class="ttc" id="aclass_c_o_f_f_i_1_1coffi_html_aeb57d11704c0ddd3ff515aa5b8c8c5a4"><div class="ttname"><a href="class_c_o_f_f_i_1_1coffi.html#aeb57d11704c0ddd3ff515aa5b8c8c5a4">COFFI::coffi::layout</a></div><div class="ttdeci">void layout()</div><div class="ttdoc">Performs the layout of the file.</div><div class="ttdef"><b>Definition</b> <a href="coffi_8hpp_source.html#l00581">coffi.hpp:581</a></div></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The coffi library takes care of the resulting binary file layout calculation. It does this on base of the provided memory image addresses and sizes. It is the user's responsibility to provide correct values for these parameters. Please refer to the documentation of the COFF architectures for specific requirements related to the executable COFF file attributes and/or mapping.</dd></dl>
<p>Similarly to the <a class="el" href="get_started.html#reader">COFF File Reader</a> example, you may use provided accessor classes to interpret and modify content of section's data.</p>
<h2><a class="anchor" id="writer_test"></a>
Testing the program</h2>
<p>Let's compile the example above (see the complete source file <a class="el" href="examples.html#examples_writer">examples/writer/writer.cpp</a>) into an executable file (named <code>writer.exe</code>). Invoking <code>writer.exe</code> will create the executable file <code>hello.exe</code> that prints the overwhelmingly impressive "Hello, World!" message.</p>
<p>The listing below works with GCC installed:</p>
<div class="fragment"><div class="line">C:\the_user_path\COFFI\examples\writer&gt;dir /B *.cpp</div>
<div class="line">writer.cpp</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;g++ writer.cpp -o writer.exe -I../..</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;writer.exe</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;dir /B *.exe</div>
<div class="line">hello.exe</div>
<div class="line">writer.exe</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;hello.exe</div>
</div><!-- fragment --><p> 
<center><img src="hello.png" title="The overwhelmingly impressive message"></center>
</p>
<p>The same thing with Visual C++:</p>
<div class="fragment"><div class="line">C:\the_user_path\COFFI\examples\writer&gt;vcvars32.bat</div>
<div class="line">**********************************************************************</div>
<div class="line">** Visual Studio 2019 Developer Command Prompt v16.6.2</div>
<div class="line">** Copyright (c) 2020 Microsoft Corporation</div>
<div class="line">**********************************************************************</div>
<div class="line">[vcvarsall.bat] Environment initialized for: &#39;x86&#39;</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;cl writer.cpp /I../.. /EHsc /nologo</div>
<div class="line">writer.cpp</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;writer.exe</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;hello.exe</div>
</div><!-- fragment --><p>In case you already compiled the <a class="el" href="get_started.html#coffdump">COFFDump Utility</a>, you can inspect the properties of the produced executable file:</p>
<div class="fragment"><div class="line">C:\the_user_path\COFFI\examples\writer&gt;..\COFFDump\COFFDump.exe hello.exe &gt; hello.dump</div>
<div class="line"> </div>
<div class="line">C:\the_user_path\COFFI\examples\writer&gt;type hello.dump</div>
</div><!-- fragment --><p>Will result in:</p>
<p><a class="anchor" id="hello_dump"></a></p><div class="fragment"><div class="line">Dump of file hello.exe</div>
<div class="line"> </div>
<div class="line">File Header</div>
<div class="line">  Machine:                      014C</div>
<div class="line">  Number of Sections:           0004</div>
<div class="line"> </div>
<div class="line">  TimeDateStamp:                00000000 (1970-01-01 01:00:00)</div>
<div class="line">  PointerToSymbolTable:         00000000</div>
<div class="line">  NumberOfSymbols:              00000000</div>
<div class="line">  SizeOfOptionalHeader:         00E0</div>
<div class="line">  Characteristics:              0102</div>
<div class="line"> </div>
<div class="line">Optional Header</div>
<div class="line">  Magic                         010B</div>
<div class="line">  linker version                0.0</div>
<div class="line">  size of code                  0200</div>
<div class="line">  size of initialized data      00000400</div>
<div class="line">  size of uninitialized data    00000000</div>
<div class="line">  entrypoint RVA                00001000</div>
<div class="line">  base of code                  00001000</div>
<div class="line">  base of data                  00002000</div>
<div class="line"> </div>
<div class="line">  image base                    0000000000400000</div>
<div class="line">  section align                 00001000</div>
<div class="line">  file align                    00000200</div>
<div class="line">  required OS version           4.0</div>
<div class="line">  image version                 1.0</div>
<div class="line">  subsystem version             4.0</div>
<div class="line">  Win32 Version                 0</div>
<div class="line">  size of image                 00005000</div>
<div class="line">  size of headers               00000200</div>
<div class="line">  checksum                      00003B01</div>
<div class="line">  Subsystem                     0003</div>
<div class="line">  DLL flags                     0000</div>
<div class="line">  stack reserve size            0000000000100000</div>
<div class="line">  stack commit size             0000000000001000</div>
<div class="line">  heap reserve size             0000000000100000</div>
<div class="line">  heap commit size              0000000000001000</div>
<div class="line">  RVAs &amp; sizes                  00000010</div>
<div class="line"> </div>
<div class="line">Data Directory</div>
<div class="line">  EXPORT_TABLE            rva: 00000000  size: 00000000</div>
<div class="line">  IMPORT_TABLE            rva: 00003000  size: 0000009C</div>
<div class="line">  RESOURCE_TABLE          rva: 00000000  size: 00000000</div>
<div class="line">  EXCEPTION_TABLE         rva: 00000000  size: 00000000</div>
<div class="line">  CERTIFICATE_TABLE       rva: 00000000  size: 00000000</div>
<div class="line">  BASE_RELOCATION_TABLE   rva: 00004000  size: 00000010</div>
<div class="line">  DEBUG                   rva: 00000000  size: 00000000</div>
<div class="line">  ARCHITECTURE            rva: 00000000  size: 00000000</div>
<div class="line">  GLOBAL_PTR              rva: 00000000  size: 00000000</div>
<div class="line">  TLS_TABLE               rva: 00000000  size: 00000000</div>
<div class="line">  LOAD_CONFIG_TABLE       rva: 00000000  size: 00000000</div>
<div class="line">  BOUND_IMPORT            rva: 00000000  size: 00000000</div>
<div class="line">  IAT                     rva: 0000304C  size: 00000010</div>
<div class="line">  DELAY_IMPORT_DESCRIPTOR rva: 00000000  size: 00000000</div>
<div class="line">  COMPLUS_RUNTIME_HEADER  rva: 00000000  size: 00000000</div>
<div class="line">  RESERVED                rva: 00000000  size: 00000000</div>
<div class="line"> </div>
<div class="line">Section Table</div>
<div class="line">  000 .text     VirtSize: 00000027  VirtAddr:  00001000</div>
<div class="line">    raw data offs:   00000400  raw data size: 00000200</div>
<div class="line">    relocation offs: 00000000  relocations:   00000000</div>
<div class="line">    line # offs:     00000000  line #&#39;s:      00000000</div>
<div class="line">    characteristics: 60300020</div>
<div class="line">      CODE EXECUTE READ ALIGN_4BYTES</div>
<div class="line"> </div>
<div class="line">  001 .rdata    VirtSize: 0000000E  VirtAddr:  00002000</div>
<div class="line">    raw data offs:   00000600  raw data size: 00000200</div>
<div class="line">    relocation offs: 00000000  relocations:   00000000</div>
<div class="line">    line # offs:     00000000  line #&#39;s:      00000000</div>
<div class="line">    characteristics: 40300040</div>
<div class="line">      INITIALIZED_DATA READ ALIGN_4BYTES</div>
<div class="line"> </div>
<div class="line">  002 .idata    VirtSize: 0000009C  VirtAddr:  00003000</div>
<div class="line">    raw data offs:   00000800  raw data size: 00000200</div>
<div class="line">    relocation offs: 00000000  relocations:   00000000</div>
<div class="line">    line # offs:     00000000  line #&#39;s:      00000000</div>
<div class="line">    characteristics: 40300040</div>
<div class="line">      INITIALIZED_DATA READ ALIGN_4BYTES</div>
<div class="line"> </div>
<div class="line">  003 .reloc    VirtSize: 00000010  VirtAddr:  00004000</div>
<div class="line">    raw data offs:   00000A00  raw data size: 00000010</div>
<div class="line">    relocation offs: 00000000  relocations:   00000000</div>
<div class="line">    line # offs:     00000000  line #&#39;s:      00000000</div>
<div class="line">    characteristics: 40300040</div>
<div class="line">      INITIALIZED_DATA READ ALIGN_4BYTES</div>
<div class="line"> </div>
<div class="line"> </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Version 1.2 &ndash; Generated on Sat Dec 30 2023 07:52:07</li>
  </ul>
</div>
<!--MAX_FRAME_SIZE GENERATE_TREEVIEW-->
<!--